---
layout: none
permalink: /well-kept-wallet/mortgage-payoff
sitemap: false
---
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;700&family=Raleway:wght@400;700&display=swap" rel="stylesheet">
</head>
<body style="background-color: white">
  <style>
    :root{
      --calculator-primary-color: #2bb34b;
      --calculator-error-color: red;
      --calculator-line-color: #e3e3e3;
      --calculator-focus-color: #333;
      --calculator-heading-font: "Raleway", sans-serif;
      --calculator-paragraph-font: "Nunito Sans", sans-serif;
    }
    .mortgage-payoff-calculator {
      font-size: 16px;
      font-family: var(--calculator-paragraph-font);
      width: calc(100% - 1rem);
      max-width: 800px;
      margin: 2rem auto;

      border-radius: 0.5rem;
      background-color: #f5f5f5;
      overflow: hidden;
    }
    .mortgage-payoff-calculator * {
      box-sizing: border-box;
    }
    .mortgage-payoff-calculator table {
      width: auto;
    }
    .mortgage-payoff-calculator th,
    .mortgage-payoff-calculator td {
      padding: 0;
      vertical-align: initial;
      text-align: center;
      border: none;
    }
    .mortgage-payoff-calculator .calculator-header {
      font-family: var(--calculator-heading-font);
      margin: 1rem 0;
      padding: 0 2rem;
      text-align: center;
    }
    .mortgage-payoff-calculator .calculator-header .calculator-title {
      font-size: 2rem;
      text-transform: uppercase;
    }
    .mortgage-payoff-calculator .calculator-body .calculator-inputs {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 2rem;
    }

    .mortgage-payoff-calculator .calculator-body .calculator-input {
      background-color: white;
      border: 1px solid var(--calculator-line-color);
      border-radius: 0.2rem;
      display: flex;
      flex-wrap: nowrap;
      justify-content: space-between;
      margin: 2rem 0.5rem;
      padding: 0.5rem 1rem;
      position: relative;
      flex: 1 0 auto;
      max-width: 30%;
      min-width: 12rem;
      transition: color 150ms ease-in-out,
                  background-color 150ms ease-in-out,
                  border-color 150ms ease-in-out;
    }
    .mortgage-payoff-calculator .calculator-body .calculator-input:focus-within {
      border-color: var(--calculator-primary-color);
    }

    .mortgage-payoff-calculator .calculator-body .calculator-input--wide {
      max-width: calc(60% + 3rem);
    }

    .mortgage-payoff-calculator .calculator-body .calculator-input--wide input {
      max-width: calc(100% - 7rem);
    }

    .mortgage-payoff-calculator .calculator-body .calculator-input--disabled,
    .mortgage-payoff-calculator .calculator-body .calculator-input--disabled label,
    .mortgage-payoff-calculator .calculator-body .calculator-input--disabled input,
    .mortgage-payoff-calculator .calculator-body .calculator-input--disabled .prefix,
    .mortgage-payoff-calculator .calculator-body .calculator-input--disabled .suffix {
      background-color: var(--line-color);
      cursor: not-allowed;
    }

    .mortgage-payoff-calculator .calculator-body .calculator-input label {
      position: absolute;
      top: -1.25rem;
      left: 0;
    }

    .mortgage-payoff-calculator .calculator-body .calculator-input .prefix,
    .mortgage-payoff-calculator .calculator-body .calculator-input .suffix {
      flex: 0 0 auto;
    }

    .mortgage-payoff-calculator .calculator-body .calculator-inputs input,
    .mortgage-payoff-calculator .calculator-body .calculator-inputs select {
      flex: 1 0 auto;
      font-family: var(--calculator-paragraph-font);
      margin: 0 0.25rem;
      outline: none;
      border: none;
      background-color: transparent;
    }

    .mortgage-payoff-calculator .calculator-body .calculator-inputs select {
      flex: 0 0 auto;
      text-align: right;
      border-left: 1px solid var(--calculator-line-color);
      padding-left: 0.75rem;
      transition: color 150ms ease-in-out,
                  background-color 150ms ease-in-out,
                  border-color 150ms ease-in-out;
    }

    .mortgage-payoff-calculator .calculator-body .calculator-input:focus-within select {
      border-left-color: var(--calculator-primary-color);
    }

    .mortgage-payoff-calculator .calculator-body .calculator-inputs input::-webkit-outer-spin-button,
    .mortgage-payoff-calculator .calculator-body .calculator-inputs input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .mortgage-payoff-calculator .calculator-body .calculator-inputs input[type=number] {
      -moz-appearance: textfield;
    }

    .mortgage-payoff-calculator .calculator-body .calculator-inputs input:focus {
      outline: none;
      border-color: var(--calculator-focus-color);
    }
    .mortgage-payoff-calculator .calculator-body .calculator-input-buttons {
      flex: 0 0 100%;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      text-align: center;
    }
    .mortgage-payoff-calculator .calculator-body .calculator-input-toggler {
      text-align: center;
      flex: 0 0 100%;
      margin: 1rem;
    }
    .mortgage-payoff-calculator .calculator-body .calculator-input-buttons button {
      flex: 0 0 auto;
      margin: 1rem;
    }
    .mortgage-payoff-calculator button {
      -webkit-appearance: button;
      -webkit-writing-mode: horizontal-tb !important;
      writing-mode: horizontal-tb !important;
      text-rendering: auto;
      color: buttontext;
      letter-spacing: normal;
      word-spacing: normal;
      text-transform: none;
      text-indent: 0px;
      text-shadow: none;
      display: inline-block;
      text-align: center;
      align-items: flex-start;
      cursor: default;
      background-color: buttonface;
      box-sizing: border-box;
      margin: 0em;
      font: 400 11px system-ui;
      padding: 1px 7px 2px;
      border-width: 1px;
      border-style: solid;
      border-color: rgb(216, 216, 216) rgb(209, 209, 209) rgb(186, 186, 186);
      border-image: initial;

      cursor: pointer;

      background-color: white;

      padding: 0.5rem;
      border-radius: 0.2rem;
      font-family: var(--calculator-paragraph-font);
      font-size: 0.75rem;
      transition: color 150ms ease-in-out,
                  background-color 150ms ease-in-out,
                  border-color 150ms ease-in-out;
    }
    .mortgage-payoff-calculator .calculator-body button.calculator-input-button--calculate {
      background-color: var(--calculator-primary-color);
      color: white;
      text-transform: uppercase;
      font-size: 1.25rem;
      border: 2px solid var(--calculator-primary-color);
    }
    .mortgage-payoff-calculator .calculator-body button.calculator-input-button--calculate:hover {
      outline: none;
      background-color: var(--calculator-focus-color);
      color: white;
    }
    .mortgage-payoff-calculator .calculator-body button.calculator-input-button--calculate:focus {
      border-color: var(--calculator-focus-color);
      outline: none;
    }
    .mortgage-payoff-calculator .calculator-body button.calculator-input-button--meta {
      background-color: transparent;
      color: var(--calculator-primary-color);
      text-transform: uppercase;
      font-size: 1rem;
      border: 2px solid transparent;
      padding: 0;
      margin: 0;
    }
    .mortgage-payoff-calculator .calculator-body button.calculator-input-button--meta:hover {
      outline: none;
      color: black;
    }
    .mortgage-payoff-calculator .calculator-body button.calculator-input-button--meta:focus {
      border-color: var(--calculator-focus-color);
      outline: none;
    }
    .mortgage-payoff-calculator .calculator-body label {
      font-family: var(--calculator-heading-font);
      font-weight: bold;
    }
    .mortgage-payoff-calculator .calculator-body .calculator-result-summary-line {
      margin: 2rem;
      font-family: var(--calculator-heading-font);
      font-weight: bold;
      font-size: 2rem;
      text-align: center;
    }
    .mortgage-payoff-calculator .calculator-body .calculator-result-summary-table,
    .mortgage-payoff-calculator .calculator-body .calculator-result-table {
      text-align: center;
    }
    .mortgage-payoff-calculator .calculator-body .calculator-result-summary-table table {
      margin: 0 auto;
      border-collapse: collapse;
    }

    .mortgage-payoff-calculator .calculator-body .calculator-result-table table {
      margin: 2rem auto;
      border-collapse: collapse;
    }

    .mortgage-payoff-calculator .calculator-body .calculator-result-summary-table table th,
    .mortgage-payoff-calculator .calculator-body .calculator-result-table table th,
    .mortgage-payoff-calculator .calculator-body .calculator-result-summary-table table td,
    .mortgage-payoff-calculator .calculator-body .calculator-result-table table td {
      padding: 0.25rem;
      border: 1px solid var(--calculator-line-color);
    }

    .mortgage-payoff-calculator .calculator-body .calculator-result-summary-table table tr,
    .mortgage-payoff-calculator .calculator-body .calculator-result-table table tr {
      transition: background-color 150ms ease-in-out,
                  color 150ms ease-in-out;
    }

    .mortgage-payoff-calculator .calculator-body .calculator-result-summary-table table th,
    .mortgage-payoff-calculator .calculator-body .calculator-result-table table th,
    .mortgage-payoff-calculator .calculator-body .calculator-result-summary-table table tr:hover,
    .mortgage-payoff-calculator .calculator-body .calculator-result-table table tr:hover {
      background-color: var(--calculator-primary-color);
      color: white;
    }

    .mortgage-payoff-calculator .calculator-body .calculator-result-summary-table tr th:first-child,
    .mortgage-payoff-calculator .calculator-body .calculator-result-summary-table tr td:first-child {
      display: none;
    }

    .calculator-result-table {
      display: none;
      margin: 2rem auto;
      overflow-x: auto;
    }

    .mortgage-payoff-calculator .calculator-body .summary-table-container {
      margin: 1rem 0;
      overflow-x: auto;
    }

    .mortgage-payoff-calculator .calculator-body .summary-table-heading {
      margin: 0 2rem;
      font-family: var(--calculator-heading-font);
      font-weight: bold;
      text-transform: uppercase;
    }

    #calculator-result-chart {
      margin: 2rem auto;
    }

    .mortgage-payoff-calculator .hidden-calc-section {
      display: none !important;
    }

    .mortgage-payoff-calculator .calculator-inputs.calculator-inputs--summary {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-evenly;
      margin: 0 2rem;
    }

    .mortgage-payoff-calculator .calculator-inputs.calculator-inputs--summary > * {
      flex: 0 0 auto;
    }

    .mortgage-payoff-calculator .calculator-inputs.calculator-inputs--summary ul {
      list-style: none;
      padding-left: 0;
    }

    .mortgage-payoff-calculator .calculator-center-text {
      text-align: center;
    }

    .mortgage-payoff-calculator .calculator-output {
      margin: 0 1rem 2rem;
    }

    .mortgage-payoff-calculator .calculator-output--line {
      margin: 2rem auto 0;
      font-size: 1.5rem;
      padding: 1rem 1rem 0;
      font-weight: bold;
      text-align: center;
    }

    .mortgage-payoff-calculator .calculator-output--title {
      margin: 1rem auto 0;
      font-size: 1.5rem;
      padding: 1rem;
      font-weight: bold;
      text-align: center;
    }

    .calculator-output.calculator-output--amortization-table.calculator-result-summary-table {
      font-size: 0.6rem;
    }

    .mortgage-payoff-calculator .calculator-output--result-table {
      display: flex;
      flex-wrap: wrap;
      padding: 2rem;
    }

    .mortgage-payoff-calculator .calculator-output--result-table .result-table__row {
      display: flex;
      flex: 0 0 100%;
      flex-wrap: nowrap;
      flex-direction: column;
    }

    .mortgage-payoff-calculator .calculator-output--result-table .result-table__cell {
      border: 1px solid var(--calculator-line-color);
      flex: 1 0 5rem;
      padding: 1rem;
      text-align: center;
    }
    .mortgage-payoff-calculator .calculator-output--result-table .result-table__cell:empty {
      border-top-color: transparent;
      border-left-color: transparent;
      background-color: initial !important;
      color: initial !important;
    }
    .mortgage-payoff-calculator .calculator-output--result-table .result-table__row.result-table__row--heading {
      font-weight: bold;
      text-align: center;
      display: none;
    }
    .mortgage-payoff-calculator .calculator-output--result-table .result-table__row.result-table__row--heading .result-table__cell {
      background-color: black;
      color: white;
    }

    .mortgage-payoff-calculator .calculator-output--result-table .result-table__row .result-table__cell:first-child {
      font-weight: bold;
      background-color: black;
      color: white;
    }
    .mortgage-payoff-calculator .result-table__row:nth-child(4) .result-table__cell:first-child {
      background-color: var(--calculator-primary-color);
    }

    .calculator-output--interest-chart canvas {
      max-height: 200px;
    }
    .calculator-output--balance-chart canvas {
      max-height: 300px;
    }

    @media screen and (min-width: 425px) {
      .calculator-output.calculator-output--amortization-table.calculator-result-summary-table {
        font-size: 0.8rem;
      }
    }

    @media screen and (min-width: 640px) {
      .mortgage-payoff-calculator .calculator-body .calculator-input {
        min-width: 15rem;
      }

      .mortgage-payoff-calculator .calculator-output--result-table .result-table__row .result-table__cell:first-child {
        text-align: left;
      }
      .mortgage-payoff-calculator .calculator-output--result-table .result-table__row {
        flex-direction: row;
      }
      .mortgage-payoff-calculator .calculator-output--result-table .result-table__row.result-table__row--heading {
        display: inherit;
      }
      .calculator-output.calculator-output--amortization-table.calculator-result-summary-table {
        font-size: 0.95rem;
      }
      .mortgage-payoff-calculator .calculator-body .calculator-input {
      }
      .mortgage-payoff-calculator .mobile-hidden {
        display: none;
      }
      .mortgage-payoff-calculator .calculator-body .calculator-inputs label {
        display: block;
      }
      .mortgage-payoff-calculator .calculator-body .calculator-result-summary-table table th,
      .mortgage-payoff-calculator .calculator-body .calculator-result-summary-table table td {
        padding: 0.5rem 1rem;
      }

      .mortgage-payoff-calculator .calculator-body .calculator-result-summary-table tr th:first-child,
      .mortgage-payoff-calculator .calculator-body .calculator-result-summary-table tr td:first-child {
        display: table-cell;
      }
    }
  </style>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js@3.8.0/dist/chart.min.js"></script>
  <script async type="text/javascript">
    const toYearsAndMonths = (rawMonths) => {
      const years = Math.floor(rawMonths / 12);
      const months = rawMonths - years * 12;

      const monthString = (months === 1) ? "1 month" : `${months} months`;

      if (years === 0) { return monthString; }

      const yearString = (years === 1) ? "1 year" : `${years} years`;

      if (months === 0) { return yearString; }

      return `${yearString} ${monthString}`;
    };
    const toCurrency = (value, digits = 2, symbol = '$') => {
      if (value === 0) {
        return "-";
      }
      return symbol + value.toLocaleString(undefined, { minimumFractionDigits: digits, maximumFractionDigits: digits});
    };
    const roundToPlaces = (value, digits) => {
      const scalar = Math.pow(10, digits);
      return Math.round((value + Number.EPSILON) * scalar) / scalar;
    };
    const payment = (pv, annualRate, months) => {
      const monthlyRate = Math.pow(1 + annualRate, 1.0 / 12) - 1;
      return pv * monthlyRate /(1-Math.pow(1 + monthlyRate, -months));
    }
    const nper = (pv, annualRate, payment) => {
      const monthlyRate = Math.pow(1 + annualRate, 1.0 / 12) - 1;
      const unroundedNper = Math.log(payment / (payment - monthlyRate * pv)) / Math.log(1 + monthlyRate)
      return roundToPlaces(unroundedNper, 3);
    }
    const remBalance = (originalBalance, annualRate, payment, nper) => {
      const monthlyRate = Math.pow(1 + annualRate, 1.0 / 12) - 1;
      return payment / monthlyRate * (1 - (1 / Math.pow(1 + monthlyRate, nper)));
    }
    const months = ['Jan.', 'Feb.', 'Mar.', 'Apr.', 'May', 'Jun.', 'Jul.', 'Aug.', 'Sep.', 'Oct.', 'Nov.', 'Dec.'];
    const toMonth = (date) => {
      if (!date) { return undefined }
      return `${months[date.getUTCMonth()]} '${date.getUTCFullYear().toFixed(0).substr(-2,2)}`;
    }
    const monthsBetween = (start, end) => {
      if (start) {
        if (end) {
          if (end <= start) {
            return 0;
          }

          const endMonths = end.getUTCFullYear() * 12 + end.getUTCMonth();
          const startMonths = start.getUTCFullYear() * 12 + start.getUTCMonth();
          return endMonths - startMonths + 1;
        }
      }
      return undefined;
    }
    const advanceMonths = (date, months) => {
      if (!date) { return undefined }
      const newDate = new Date(typeof date === 'number' ? date : date.getTime());
      newDate.setUTCMonth(newDate.getUTCMonth() + months);
      newDate.setUTCDate(1);
      return newDate;
    }
    const runScenario = (currentBalance, interestRate, basePayment, startDate, today, monthless, extraPayment = 0, extraPaymentFreq = undefined) => {
      const monthlyRate = Math.pow(1 + interestRate, 1.0 / 12) - 1;

      const amortizationTable = [];
      /* If no frequency, one-time right now */
      let intermedBalance = extraPaymentFreq ? currentBalance : currentBalance - extraPayment;
      while(intermedBalance > 0.01) {
        const start = intermedBalance;
        const interest = start * monthlyRate;

        let proposedPayment = basePayment;
        if (extraPaymentFreq) {
          if (extraPaymentFreq > 0)
            if (extraPaymentFreq < 1) {
              proposedPayment += (extraPayment / extraPaymentFreq);
            } else if (amortizationTable.length % extraPaymentFreq === 0) {
            proposedPayment += extraPayment
          } else if (amortizationTable.length % extraPaymentFreq === 0) {
            proposedPayment += extraPayment
          }
        }

        const paymentMade = Math.min(proposedPayment, start + interest);
        const end = roundToPlaces(intermedBalance + interest - paymentMade, 8);
        const entryDate = monthless ? `Month ${amortizationTable.length + 1}` : toMonth(advanceMonths(Math.max(startDate, today), amortizationTable.length));
        amortizationTable.push({
          start,
          interest,
          payment: paymentMade,
          principal: paymentMade - interest,
          date: entryDate,
          end
        })
        intermedBalance = end;
      }

      const remainingNper = amortizationTable.length
      const remainingTotalCost = amortizationTable.reduce((total, element) => {
        return total + element.payment;
      }, 0.0)
      const remainingInterest = remainingTotalCost - currentBalance;

      return {
        remainingNper,
        remainingTotalCost,
        remainingInterest,
        amortizationTable,
        dates: {
          start: monthless ? `Month 1` : toMonth(startDate),
          current: monthless ? `Month 1` : toMonth(today),
          end: monthless ? `Month ${remainingNper}` : toMonth(advanceMonths(Math.max(today, startDate), startDate > today ? remainingNper - 1 : remainingNper)),
        }
      };
    }
    const setupCharts = (calculator) => {
      Chart.defaults.font.size = 16;
      Chart.defaults.font.family = "Nunito Sans, sans-serif";
      const interestChartElement = calculator.querySelector('.calculator-output--interest-chart canvas');
      const interestChart = new Chart(interestChartElement, {
          type: 'bar',
          data: {
              labels: ['No Prepayment', 'With Prepayment'],
              datasets: [{
                  label: 'Remaining Interest',
                  data: [],
                  backgroundColor: [
                    '#333333',
                    '#2bb34b'
                  ],
                  borderColor: [
                    '#333333',
                    '#2bb34b'
                  ],
                  borderWidth: 1
              }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            scales: {
                y: {
                    min: 0
                },
                x: {
                  ticks: {
                    callback: function(value, index, ticks) {
                        return toCurrency(value, 0);
                    }
                }
                }
            },
            plugins: {
              legend: {
                position: 'none',
              },
              title: {
                display: false,
                text: 'Remaining Interest',
                font: {
                  family: 'Raleway, sans-serif',
                  size: 20,
                }
              },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    let label = context.dataset.label;

                    if (label) {
                      label += ': ';
                    } else {
                      label = '';
                    }
                    if (context.parsed.x !== null) {
                      label += toCurrency(context.parsed.x, 0);
                    }
                    return label;
                  }
                }
              },
            }
          }
      });

      const balanceChartElement = calculator.querySelector('.calculator-output--balance-chart canvas');
      const balanceChart = new Chart(balanceChartElement, {
          type: 'line',
          data: {
            labels: ['Jan 2022', 'Feb 2022', 'Mar 2022', 'Apr 2022', 'May 2022'],
              datasets: [{
                  label: 'No Prepayment',
                  data: [1, 2, 3, 4, 5],
                  backgroundColor: [
                    '#333333'
                  ],
                  borderColor: [
                    '#333333'
                  ],
                  borderWidth: 1
              },
              {
                  label: 'With Prepayment',
                  data: [5, 4, 3, 2, 1],
                  backgroundColor: [
                    '#2bb34b'
                  ],
                  borderColor: [
                    '#2bb34b'
                  ],
                  borderWidth: 1
              }]
          },
          options: {
            responsive: true,
            scales: {
                y: {
                  ticks: {
                    callback: function(value, index, ticks) {
                        return toCurrency(value, 0);
                    }
                }
                }
            },
            plugins: {
              legend: {
                position: 'none',
              },
              title: {
                display: false,
                text: 'Principal Balance',
                font: {
                  family: 'Raleway, sans-serif',
                  size: 20,
                }
              },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    let label = context.dataset.label;

                    if (label) {
                      label += ': ';
                    } else {
                      label = '';
                    }
                    if (context.parsed.y !== null) {
                      label += toCurrency(context.parsed.y, 0);
                    }
                    return label;
                  }
                }
              }
            }
          }
      });
      return {
        interest: interestChart,
        balance: balanceChart
      };
    }

    const updateChartData = (charts, baseScenario, prepayScenario) => {
      charts.interest.data.datasets[0].data = [baseScenario.remainingInterest, prepayScenario.remainingInterest];
      charts.interest.update();

      charts.balance.data.labels = baseScenario.amortizationTable.map((month) => month.date);
      charts.balance.data.datasets[0].data = baseScenario.amortizationTable.map((month) => month.end);
      charts.balance.data.datasets[1].data = prepayScenario.amortizationTable.map((month) => month.end);
      charts.balance.update();
    }

    const updateTableData = (table, baseScenario, prepayScenario) => {
      const rows = table.querySelectorAll('tr');
      for(let i = 1; i < rows.length; i += 1) {
        table.removeChild(rows[i]);
      }

      prepayScenario.amortizationTable.forEach((month) => {
        const row = document.createElement('tr');
        ['date', 'start', 'payment', 'interest', 'principal', 'end'].forEach((attr) => {
          const cell = document.createElement('td');
          if (attr !== 'date') {
            cell.appendChild(document.createTextNode(toCurrency(month[attr], 0)));
          } else {
            cell.appendChild(document.createTextNode(month[attr]));
          }
          row.appendChild(cell);
        })
        table.appendChild(row);
      })
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log("Calculator helper functions loaded");

      const calculators = document.querySelectorAll('.mortgage-payoff-calculator');
      calculators.forEach((calculator) => {
        if (calculator) {
          console.log("Calculator instance found");

          const inputs = calculator.querySelectorAll('input');
          const selects = calculator.querySelectorAll('select');
          const buttons = calculator.querySelectorAll('button');

          const inputSection = calculator.querySelector('.calculator-inputs--mortgage');
          const outputSection = calculator.querySelector('.calculator-outputs');

          const charts = setupCharts(calculator);
          const table = calculator.querySelector('.calculator-output--amortization-table table');

          let states = ['basic', 'results'];
          let currentState = 'basic';

          const advanceState = () => {
            const startIndex = states.findIndex((state) => state === currentState);
            const endIndex = Math.min(startIndex + 1, states.length - 1);
            currentState = states[endIndex];
            renderState();
          }
          const retreatState = () => {
            const startIndex = states.findIndex((state) => state === currentState);
            const endIndex = Math.max(startIndex - 1, 0);
            currentState = states[endIndex];
            renderState();
          }

          let overrideInputs = false;

          const toggleInputs = () => {
            overrideInputs = !overrideInputs;
            if (overrideInputs) {
              calculator.querySelector('#original-loan-amount').parentNode.classList.add('hidden-calc-section');
              calculator.querySelector('#loan-term').parentNode.classList.add('hidden-calc-section');
              calculator.querySelector('#current-loan-amount').readOnly = false;
              calculator.querySelector('#monthly-payment').readOnly = false;
              calculator.querySelector('#current-loan-amount').parentNode.classList.remove('calculator-input--disabled');
              calculator.querySelector('#monthly-payment').parentNode.classList.remove('calculator-input--disabled');
              calculator.querySelector('button[name=input-toggle]').innerHTML = 'Calculate payment and loan amount'
            } else {
              calculator.querySelector('#original-loan-amount').parentNode.classList.remove('hidden-calc-section');
              calculator.querySelector('#loan-term').parentNode.classList.remove('hidden-calc-section');
              calculator.querySelector('#current-loan-amount').readOnly = true;
              calculator.querySelector('#monthly-payment').readOnly = true;
              calculator.querySelector('#current-loan-amount').parentNode.classList.add('calculator-input--disabled');
              calculator.querySelector('#monthly-payment').parentNode.classList.add('calculator-input--disabled');
              calculator.querySelector('button[name=input-toggle]').innerHTML = 'Set payment and loan amount directly'
            }
          }

          const validateInputs = () => {
            const allValid = Array.from(inputs).every((input) => {
              if (input.id === 'first-payment-date') {
                return input.reportValidity();
              }
              if (overrideInputs) {
                if (input.id === 'original-loan-amount') {
                  return true;
                }
                if (input.id === 'loan-term') {
                  return true;
                }
              }
              return input.value ? input.reportValidity() : false;
            });
            if (!allValid) {
              currentState = 'basic';
            }
          }

          const renderState = () => {
            validateInputs();
            switch(currentState) {
              case 'basic':
                inputSection.classList.remove('hidden-calc-section')
                outputSection.classList.add('hidden-calc-section')
                break;
              case 'results':
                inputSection.classList.add('hidden-calc-section')
                outputSection.classList.remove('hidden-calc-section')
                break;
            }
          }

          const updateResults = () => {
            console.log('Calculator updating');
            inputs.forEach((input) => {
              input.reportValidity();
            })
            selects.forEach((select) => {
              select.reportValidity();
            })
            const loanAmount = parseFloat(calculator.querySelector('#original-loan-amount').value);
            const startDateEntered = Date.parse(calculator.querySelector('#first-payment-date').value);
            const loanTerm = parseFloat(calculator.querySelector('#loan-term').value) * 12;
            const interestRate = parseFloat(calculator.querySelector('#interest-rate').value) / 100.0;
            const extraPaymentAmount = parseFloat(calculator.querySelector('#extra-payment-amount').value);
            const extraPaymentFrequency = parseFloat(calculator.querySelector('#extra-payment-frequency').value)

            const today = new Date();
            const startDate = startDateEntered ? new Date(startDateEntered) : new Date(today.getFullYear(), today.getMonth() + 1, 0);

            /* Interim calculation */
            const monthsElapsed = monthsBetween(startDate, today);

            let basePayment;
            let currentBalance;

            /* Interim calculations - open for override */
            if (overrideInputs) {
              basePayment = parseFloat(calculator.querySelector('#monthly-payment').value);
              currentBalance = parseFloat(calculator.querySelector('#current-loan-amount').value);
            } else {
              basePayment = payment(loanAmount, interestRate, loanTerm)
              currentBalance = remBalance(loanAmount, interestRate, basePayment, loanTerm - monthsElapsed)
              calculator.querySelector('#current-loan-amount').value = currentBalance.toFixed(2);
              calculator.querySelector('#monthly-payment').value = basePayment.toFixed(2);
            }

            calculator.querySelector('.calculator-inputs--summary span[name=original-amount-summary]').innerHTML = overrideInputs ? 'Not Entered' : toCurrency(loanAmount, 0);
            calculator.querySelector('.calculator-inputs--summary span[name=loan-term]').innerHTML = overrideInputs ? 'Not Entered' : `${Math.round(loanTerm / 12)} years`;
            calculator.querySelector('.calculator-inputs--summary span[name=interest-rate]').innerHTML = `${(interestRate * 100.0).toFixed(3)}%`;
            calculator.querySelector('.calculator-inputs--summary span[name=first-payment]').innerHTML = startDateEntered ? toMonth(startDate) : 'Not Entered';
            calculator.querySelector('.calculator-inputs--summary span[name=current-balance]').innerHTML = toCurrency(currentBalance, 0);
            calculator.querySelector('.calculator-inputs--summary span[name=standard-payment]').innerHTML = toCurrency(basePayment, 2);
            let extraPaymentTag = '';
            switch(extraPaymentFrequency) {
              case 0: extraPaymentTag = 'once'; break;
              case 0.23013679714: extraPaymentTag = 'per week'; break;
              case 1: extraPaymentTag = 'per month'; break;
              case 3: extraPaymentTag = 'per quarter'; break;
              case 12: extraPaymentTag = 'per year'; break;
            }
            if (extraPaymentFrequency >= 1) {
              calculator.querySelector('.calculator-inputs--summary span[name=extra-payment]').innerHTML = `${toCurrency(extraPaymentAmount, 2)} ${extraPaymentTag}`
            }

            /* Base scenario */
            const baseScenario = runScenario(currentBalance, interestRate, basePayment, startDate, today, !startDateEntered);

            /* Prepay scenario */
            const prepayScenario = runScenario(currentBalance, interestRate, basePayment, startDate, today, !startDateEntered, extraPaymentAmount, extraPaymentFrequency);

            calculator.querySelector('.result-table__cell--with-pp-date').innerHTML = prepayScenario.dates.end;
            calculator.querySelector('.result-table__cell--with-pp-interest').innerHTML = toCurrency(prepayScenario.remainingInterest, 0);
            calculator.querySelector('.result-table__cell--with-pp-total').innerHTML = toCurrency(prepayScenario.remainingTotalCost, 0);

            calculator.querySelector('.result-table__cell--wo-pp-date').innerHTML = baseScenario.dates.end;
            calculator.querySelector('.result-table__cell--wo-pp-interest').innerHTML = toCurrency(baseScenario.remainingInterest, 0);
            calculator.querySelector('.result-table__cell--wo-pp-total').innerHTML = toCurrency(baseScenario.remainingTotalCost, 0);

            calculator.querySelector('.calculator-output--line').innerHTML = `With prepayment, you'll save ${toCurrency(baseScenario.remainingTotalCost - prepayScenario.remainingTotalCost, 0)} and ${toYearsAndMonths(baseScenario.remainingNper - prepayScenario.remainingNper)}!`

            updateChartData(charts, baseScenario, prepayScenario);
            updateTableData(table, baseScenario, prepayScenario);

            renderState();
          };

          updateResults();

          inputs.forEach((input) => { input.addEventListener('blur', updateResults)});
          selects.forEach((select) => { select.addEventListener('change', updateResults)})
          calculator.querySelector('button[name=submit-interim]').addEventListener('click', advanceState);
          calculator.querySelector('button[name=back-results]').addEventListener('click', retreatState);
          calculator.querySelector('button[name=input-toggle]').addEventListener('click', toggleInputs);
        };
      });
    });
  </script>

  <div class="mortgage-payoff-calculator">
    <div class="calculator-body">
      <div class="calculator-inputs calculator-inputs--mortgage">
        <div class="calculator-input">
          <label for="original-loan-amount">Original Loan Amount</label>
          <span class="input-prefix">$</span>
          <input type="number" id="original-loan-amount" min="0" inputmode="numeric" autocomplete="off" />
        </div>
        <div class="calculator-input">
          <label for="loan-term">Loan Term</label>
          <input type="number" id="loan-term" style="text-align: right;" min="1" max="100" step="0.25" inputmode="numeric" autocomplete="off" />
          <span class="input-suffix">years</span>
        </div>
        <div class="calculator-input">
          <label for="interest-rate">Interest Rate</label>
          <input type="number" id="interest-rate" style="text-align: right;" min="0" max="25" step="0.001" inputmode="numeric" autocomplete="off" />
          <span class="input-suffix">%</span>
        </div>
        <div class="calculator-input">
          <label for="first-payment-date">First Payment (optional)</label>
          <input type="month" id="first-payment-date" pattern="(|[0-9]{4}-[0-9]{2})" placeholder="YYYY-MM" />
        </div>
        <div class="calculator-input-toggler">
          <button class="calculator-input-button--meta" name="input-toggle">Set payment and loan amount directly</button>
        </div>
        <div class="calculator-input calculator-input--disabled">
          <label for="monthly-payment">Monthly Payment</label>
          <span class="input-prefix">$</span>
          <input type="number" id="monthly-payment" min="0" step="0.01" inputmode="numeric" autocomplete="off" readonly />
        </div>
        <div class="calculator-input calculator-input--disabled">
          <label for="current-loan-amount">Current Loan Amount</label>
          <span class="input-prefix">$</span>
          <input type="number" id="current-loan-amount" min="0" step="0.01" inputmode="numeric" autocomplete="off" readonly />
        </div>
        <div class="calculator-input calculator-input--wide">
          <label for="extra-payment-amount">Extra Payment</label>
          <span class="input-prefix">$</span>
          <input type="number" id="extra-payment-amount" inputmode="numeric" step=0.01 autocomplete="off" />
          <select name="extra-payment-frequency" id="extra-payment-frequency">
            <option value=0>One time</option>
            <option value=0.23013679714>Weekly</option>
            <option value=1 selected>Monthly</option>
            <option value=3>Quarterly</option>
            <option value=12>Yearly</option>
          </select>
        </div>
        <div class="calculator-input-buttons">
          <button class="calculator-input-button--calculate" name="submit-interim">Calculate</button>
        </div>
      </div>
      <div class="calculator-outputs hidden-calc-section">
        <div class="calculator-output">
          <div class="calculator-output--line">Calculator Loading...</div>
        </div>
        <div class="calculator-output calculator-center-text">Want more details? See below for your detailed analysis.</div>
        <div class="calculator-output--title">Your Inputs</div>
        <div class="calculator-inputs calculator-inputs--summary">
          <ul>
            <li>Original Amount: <span name="original-amount-summary"></span></li>
            <li>Loan Term: <span name="loan-term"></span></li>
            <li>Interest Rate: <span name="interest-rate"></span></li>
            <li>First Payment: <span name="first-payment"></span></li>
          </ul>
          <ul>
            <li>Current Balance: <span name="current-balance"></span></li>
            <li>Standard Payment: <span name="standard-payment"></span></li>
            <li>Extra Payment: <span name="extra-payment"></span></li>
          </ul>
        </div>
        <div class="calculator-center-text"><button class="calculator-input-button--meta" name="back-results">Edit</button></div>
        <div class="calculator-output calculator-output--result-table">
          <div class="calculator-output--title">Payoff Comparison</div>
          <div class="result-table__row result-table__row--heading">
            <div class="result-table__cell"></div>
            <div class="result-table__cell">Payoff Date</div>
            <div class="result-table__cell">Remaining Interest</div>
            <div class="result-table__cell">Remaining Cost</div>
          </div>
          <div class="result-table__row">
            <div class="result-table__cell">No<br />Prepayment</div>
            <div class="result-table__cell"><span class="mobile-hidden">Payoff Date: </span><span class="result-table__cell--wo-pp-date"></span></div>
            <div class="result-table__cell"><span class="mobile-hidden">Remaining Interest: </span><span class=" result-table__cell--wo-pp-interest"></span></div>
            <div class="result-table__cell"><span class="mobile-hidden">Remaining Cost: </span><span class="result-table__cell--wo-pp-total"></span></div>
          </div>
          <div class="result-table__row">
            <div class="result-table__cell">With<br />Prepayment</div>
            <div class="result-table__cell"><span class="mobile-hidden">Payoff Date: </span><span class="result-table__cell--with-pp-date"></span></div>
            <div class="result-table__cell"><span class="mobile-hidden">Remaining Interest: </span><span class=" result-table__cell--with-pp-interest"></span></div>
            <div class="result-table__cell"><span class="mobile-hidden">Remaining Cost: </span><span class="result-table__cell--with-pp-total"></span></div>
          </div>
        </div>
        <div class="calculator-output calculator-output--interest-chart">
          <div class="calculator-output--title">Remaining Interest</div>
          <canvas width="300" height="200"></canvas>
        </div>
        <div class="calculator-output calculator-output--balance-chart">
          <div class="calculator-output--title">Balance Payoff</div>
          <canvas width="300" height="200"></canvas>
        </div>
        <div class="calculator-output calculator-output--amortization-table calculator-result-summary-table">
          <div class="calculator-output--title">Amortization Table (with prepayment)</div>
          <table>
            <tr>
              <th>Month</th>
              <th>Start</th>
              <th>Payment</th>
              <th>Interest</th>
              <th>Principal</th>
              <th>End</th>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
